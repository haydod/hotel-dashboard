<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Regional Hotel Manager Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .dashboard-container {
            max-width: 1600px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        h1 {
            color: #1a202c;
            font-size: 28px;
            font-weight: 700;
        }

        .live-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            background: #10b981;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }

        .live-dot {
            width: 8px;
            height: 8px;
            background: white;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .date-time {
            color: #6b7280;
            font-size: 14px;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .metric-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .metric-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .metric-title {
            color: #6b7280;
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .metric-value {
            font-size: 36px;
            font-weight: 700;
            color: #1a202c;
            margin-bottom: 8px;
        }

        .metric-change {
            font-size: 14px;
            font-weight: 600;
            padding: 4px 8px;
            border-radius: 4px;
            display: inline-block;
        }

        .metric-change.positive {
            background: #d1fae5;
            color: #065f46;
        }

        .metric-change.negative {
            background: #fee2e2;
            color: #991b1b;
        }

        .properties-section {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .section-title {
            font-size: 20px;
            font-weight: 700;
            color: #1a202c;
            margin-bottom: 20px;
        }

        .properties-table {
            width: 100%;
            border-collapse: collapse;
        }

        .properties-table th {
            text-align: left;
            padding: 12px;
            background: #f9fafb;
            color: #6b7280;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 2px solid #e5e7eb;
        }

        .properties-table td {
            padding: 16px 12px;
            border-bottom: 1px solid #e5e7eb;
            color: #1a202c;
        }

        .properties-table tr:hover {
            background: #f9fafb;
        }

        .property-name {
            font-weight: 600;
            color: #667eea;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
        }

        .status-good {
            background: #d1fae5;
            color: #065f46;
        }

        .status-warning {
            background: #fef3c7;
            color: #92400e;
        }

        .status-critical {
            background: #fee2e2;
            color: #991b1b;
        }

        .score-circle {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-weight: 700;
            font-size: 14px;
        }

        .score-high {
            background: #d1fae5;
            color: #065f46;
        }

        .score-medium {
            background: #fef3c7;
            color: #92400e;
        }

        .score-low {
            background: #fee2e2;
            color: #991b1b;
        }

        .events-section, .pricing-section {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .event-item {
            display: flex;
            gap: 16px;
            padding: 16px;
            border-left: 4px solid #667eea;
            background: #f9fafb;
            border-radius: 8px;
            margin-bottom: 12px;
        }

        .event-date {
            font-weight: 700;
            color: #667eea;
            min-width: 80px;
        }

        .event-details {
            flex: 1;
        }

        .event-name {
            font-weight: 600;
            color: #1a202c;
            margin-bottom: 4px;
        }

        .event-location {
            color: #6b7280;
            font-size: 14px;
        }

        .pickup-card {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            background: #ffffff;
        }

        .pickup-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .pickup-property {
            font-weight: 600;
            color: #1a202c;
        }

        .pickup-metrics {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
        }

        .pickup-metric {
            text-align: center;
        }

        .pickup-metric-label {
            font-size: 11px;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }

        .pickup-metric-value {
            font-size: 20px;
            font-weight: 700;
            color: #1a202c;
        }

        .pickup-trend {
            font-size: 12px;
            font-weight: 600;
            margin-top: 2px;
        }

        .pickup-progress {
            width: 100%;
            height: 6px;
            background: #e5e7eb;
            border-radius: 3px;
            overflow: hidden;
            margin-top: 12px;
        }

        .pickup-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s ease;
        }

        .pricing-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
        }

        .pricing-card {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 16px;
        }

        .pricing-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .competitor-name {
            font-weight: 600;
            color: #1a202c;
        }

        .price-comparison {
            display: flex;
            gap: 16px;
            align-items: center;
        }

        .price-value {
            font-size: 24px;
            font-weight: 700;
        }

        .price-diff {
            font-size: 14px;
            font-weight: 600;
        }

        .refresh-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }

        .refresh-btn:hover {
            background: #5568d3;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .property-selector-section {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .selector-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .property-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 16px;
        }

        .property-card {
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
            position: relative;
        }

        .property-card:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }

        .property-card-name {
            font-size: 18px;
            font-weight: 700;
            color: #1a202c;
            margin-bottom: 4px;
        }

        .property-card-location {
            color: #6b7280;
            font-size: 14px;
            margin-bottom: 16px;
        }

        .property-card-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .property-card-stat {
            text-align: center;
            position: relative;
            padding: 10px 8px;
            border-radius: 8px;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .property-card-stat.warning {
            background: #fffbeb;
            border-color: #fbbf24;
        }

        .property-card-stat.critical {
            background: #fef2f2;
            border-color: #ef4444;
        }

        .property-card-stat.positive-highlight {
            background: #f0fdf4;
            border-color: #10b981;
        }

        .stat-indicator {
            position: absolute;
            top: 4px;
            right: 4px;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: pulse-warning 2s infinite;
        }

        .stat-indicator.warning {
            background: #fbbf24;
        }

        .stat-indicator.critical {
            background: #ef4444;
        }

        .stat-indicator.positive {
            background: #10b981;
        }

        @keyframes pulse-warning {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.1); }
        }

        .property-card-stat-label {
            font-size: 11px;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }

        .property-card-stat-value {
            font-size: 18px;
            font-weight: 700;
            color: #1a202c;
        }

        .property-header-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .property-header-content {
            color: white;
        }

        .selected-property-title {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 4px;
            color: white;
        }

        .selected-property-location {
            font-size: 16px;
            opacity: 0.9;
        }

        .back-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid white;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .back-btn:hover {
            background: white;
            color: #667eea;
        }

        .pickup-detail-card {
            background: #f9fafb;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 12px;
        }

        .pickup-detail-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .pickup-detail-label {
            color: #6b7280;
            font-size: 14px;
            font-weight: 600;
        }

        .pickup-detail-value {
            font-size: 20px;
            font-weight: 700;
            color: #1a202c;
        }

        .stly-comparison {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 4px;
        }

        .stly-label {
            font-size: 12px;
            color: #6b7280;
        }

        .stly-value {
            font-size: 13px;
            font-weight: 600;
            padding: 2px 8px;
            border-radius: 4px;
        }

        .stly-value.positive {
            background: #d1fae5;
            color: #065f46;
        }

        .stly-value.negative {
            background: #fee2e2;
            color: #991b1b;
        }

        .stly-value.neutral {
            background: #f3f4f6;
            color: #6b7280;
        }

        .metric-with-stly {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        @media (max-width: 1024px) {
            .grid-2 {
                grid-template-columns: 1fr;
            }
            .property-grid {
                grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <div class="header">
            <div class="header-top">
                <h1>Regional Hotel Manager Dashboard</h1>
                <div class="live-indicator">
                    <span class="live-dot"></span>
                    <span>LIVE</span>
                </div>
            </div>
            <div class="date-time" id="dateTime"></div>
        </div>

        <div class="property-selector-section">
            <div class="selector-header">
                <h2 class="section-title" style="margin-bottom: 0;">Select Property</h2>
                <div style="display: flex; gap: 12px;">
                    <button class="refresh-btn" onclick="enableCSVImport()" style="background: #10b981;">Import CSV</button>
                    <button class="refresh-btn" onclick="syncAllProperties()" style="background: #8b5cf6;">Sync PMS</button>
                    <button class="refresh-btn" onclick="refreshData()">Refresh Data</button>
                </div>
            </div>
            <div class="property-grid" id="propertyGrid"></div>
        </div>

        <div id="propertyDetails" style="display: none;">
            <div class="property-header-card">
                <div class="property-header-content">
                    <h2 id="selectedPropertyName" class="selected-property-title"></h2>
                    <p id="selectedPropertyLocation" class="selected-property-location"></p>
                </div>
                <button class="back-btn" onclick="showPropertySelector()">← Back to All Properties</button>
            </div>

            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-header">
                        <span class="metric-title">RevPAR</span>
                    </div>
                    <div class="metric-with-stly">
                        <div class="metric-value" id="propertyRevPAR">$0</div>
                        <div class="stly-comparison">
                            <span class="stly-label">vs STLY:</span>
                            <span class="stly-value" id="revparStly">+0%</span>
                        </div>
                    </div>
                </div>

                <div class="metric-card">
                    <div class="metric-header">
                        <span class="metric-title">Guest Score</span>
                    </div>
                    <div class="metric-with-stly">
                        <div class="metric-value" id="propertyGuestScore">0</div>
                        <span class="metric-change positive" id="propertyScoreChange">+0.2 vs last month</span>
                    </div>
                </div>

                <div class="metric-card">
                    <div class="metric-header">
                        <span class="metric-title">7-Day Pick-Up</span>
                    </div>
                    <div class="metric-with-stly">
                        <div class="metric-value" id="propertyPickup7">0</div>
                        <div class="stly-comparison">
                            <span class="stly-label">vs STLY:</span>
                            <span class="stly-value" id="pickup7Stly">+0%</span>
                        </div>
                    </div>
                </div>

                <div class="metric-card">
                    <div class="metric-header">
                        <span class="metric-title">OTB Next 30</span>
                    </div>
                    <div class="metric-with-stly">
                        <div class="metric-value" id="propertyOtb">0</div>
                        <div class="stly-comparison">
                            <span class="stly-label">vs STLY:</span>
                            <span class="stly-value" id="otbStly">+0%</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="grid-2">
                <div class="events-section">
                    <h2 class="section-title">Pick-Up Details</h2>
                    <div id="propertyPickupDetails"></div>
                </div>

                <div class="pricing-section">
                    <h2 class="section-title">Competitive Pricing</h2>
                    <div id="propertyPricingDetails"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ========================================
        // CENTRAL COAST HOTEL DASHBOARD
        // CloudBeds & ASI (Anand Systems) Integration
        // ========================================

        // API CONFIGURATION
        // TODO: Add your API credentials here
        const API_CONFIG = {
            cloudbeds: {
                clientId: 'live1_3I7208_6KpdzONLviiq5wef0nCRFoX7',
                clientSecret: '0pioWJ7PEh6s3NfwxFckCyvZYmUQSBI9',
                apiEndpoint: 'https://hotels.cloudbeds.com/api/v1.2'
            },
            asi: {
                apiKey: 'YOUR_ASI_API_KEY',
                apiEndpoint: 'YOUR_ASI_API_ENDPOINT',
                // ASI may use different authentication - update as needed
            },
            galaxyLightspeed: {
                username: 'YOUR_GALAXY_USERNAME',
                password: 'YOUR_GALAXY_PASSWORD',
                hotelCode: 'YOUR_HOTEL_CODE',
                apiEndpoint: 'https://api.galaxypos.com', // Verify with Galaxy support
            },
            autoClerk: {
                apiKey: 'YOUR_AUTOCLERK_API_KEY',
                propertyId: 'YOUR_PROPERTY_ID',
                apiEndpoint: 'https://api.autoclerk.net/v1', // Verify with AutoClerk support
            }
        };

        // CSV IMPORT FUNCTIONALITY
        function enableCSVImport() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.csv';
            input.onchange = handleCSVUpload;
            input.click();
        }

        function handleCSVUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const csv = e.target.result;
                parseCSVData(csv);
            };
            reader.readAsText(file);
        }

        function parseCSVData(csv) {
            // Expected CSV format:
            // PropertyName,Location,RevPAR,GuestScore,Pickup7Day,Pickup30Day,OTB30,STLYRevPAR,STLYPickup7,STLYPickup30,STLYOTB,Staffed
            const lines = csv.split('\n');
            const headers = lines[0].split(',');
            
            for (let i = 1; i < lines.length; i++) {
                if (!lines[i].trim()) continue;
                
                const values = lines[i].split(',');
                const propertyName = values[0]?.trim();
                
                // Find matching property
                const property = properties.find(p => p.name.includes(propertyName));
                if (property) {
                    property.revpar = parseFloat(values[2]) || 0;
                    property.guestScore = parseFloat(values[3]) || 0;
                    property.pickup7day = parseInt(values[4]) || 0;
                    property.pickup30day = parseInt(values[5]) || 0;
                    property.otbNext30 = parseInt(values[6]) || 0;
                    property.stlyRevpar = parseFloat(values[7]) || 0;
                    property.stlyPickup7 = parseInt(values[8]) || 0;
                    property.stlyPickup30 = parseInt(values[9]) || 0;
                    property.stlyOtb = parseInt(values[10]) || 0;
                    property.staffed = values[11]?.trim().toLowerCase() === 'true';
                }
            }
            
            renderPropertyGrid();
            alert('CSV data imported successfully!');
        }

        // CLOUDBEDS API INTEGRATION
        async function fetchCloudBedsData(propertyId) {
            try {
                // First, get OAuth token
                const tokenResponse = await fetch('https://hotels.cloudbeds.com/api/v1.2/access_token', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `grant_type=client_credentials&client_id=${API_CONFIG.cloudbeds.clientId}&client_secret=${API_CONFIG.cloudbeds.clientSecret}`
                });
                
                const tokenData = await tokenResponse.json();
                const accessToken = tokenData.access_token;

                // Fetch reservation data
                const reservationsResponse = await fetch(
                    `${API_CONFIG.cloudbeds.apiEndpoint}/getReservations?propertyID=${propertyId}`,
                    {
                        headers: {
                            'Authorization': `Bearer ${accessToken}`
                        }
                    }
                );
                
                const reservationsData = await reservationsResponse.json();
                return reservationsData;
                
            } catch (error) {
                console.error('CloudBeds API Error:', error);
                return null;
            }
        }

        // ASI (ANAND SYSTEMS) API INTEGRATION
        async function fetchASIData(propertyCode) {
            try {
                // ASI uses SOAP or REST depending on your setup
                // This is a template - adjust based on your ASI implementation
                const response = await fetch(
                    `${API_CONFIG.asi.apiEndpoint}/getPropertyStats?propertyCode=${propertyCode}`,
                    {
                        headers: {
                            'X-API-Key': API_CONFIG.asi.apiKey,
                            'Content-Type': 'application/json'
                        }
                    }
                );
                
                const data = await response.json();
                return data;
                
            } catch (error) {
                console.error('ASI API Error:', error);
                return null;
            }
        }

        // GALAXY LIGHTSPEED PMS API INTEGRATION
        async function fetchGalaxyLightspeedData(hotelCode) {
            try {
                // Galaxy Lightspeed typically uses username/password authentication
                const response = await fetch(
                    `${API_CONFIG.galaxyLightspeed.apiEndpoint}/hotels/${hotelCode}/statistics`,
                    {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Basic ' + btoa(`${API_CONFIG.galaxyLightspeed.username}:${API_CONFIG.galaxyLightspeed.password}`)
                        }
                    }
                );
                
                const data = await response.json();
                return data;
                
            } catch (error) {
                console.error('Galaxy Lightspeed API Error:', error);
                return null;
            }
        }

        // AUTOCLERK CLOUD API INTEGRATION
        async function fetchAutoClerkData(propertyId) {
            try {
                // AutoClerk Cloud uses API key authentication
                const response = await fetch(
                    `${API_CONFIG.autoClerk.apiEndpoint}/properties/${propertyId}/stats`,
                    {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-API-Key': API_CONFIG.autoClerk.apiKey
                        }
                    }
                );
                
                const data = await response.json();
                return data;
                
            } catch (error) {
                console.error('AutoClerk Cloud API Error:', error);
                return null;
            }
        }

        // PROCESS PMS DATA INTO DASHBOARD FORMAT
        async function updatePropertyFromPMS(property) {
            let data;
            
            if (property.pmsSystem === 'CloudBeds') {
                data = await fetchCloudBedsData(property.cloudBedsId);
                if (data) {
                    // Map CloudBeds response to property fields
                    // Adjust these mappings based on actual CloudBeds API response structure
                    property.revpar = calculateRevPAR(data);
                    property.pickup7day = calculatePickup(data, 7);
                    property.pickup30day = calculatePickup(data, 30);
                    property.otbNext30 = calculateOTB(data, 30);
                }
            } else if (property.pmsSystem === 'ASI') {
                data = await fetchASIData(property.asiCode);
                if (data) {
                    // Map ASI response to property fields
                    property.revpar = data.revpar || 0;
                    property.pickup7day = data.pickup7 || 0;
                    property.pickup30day = data.pickup30 || 0;
                    property.otbNext30 = data.otb30 || 0;
                }
            } else if (property.pmsSystem === 'GalaxyLightspeed') {
                data = await fetchGalaxyLightspeedData(property.galaxyHotelCode);
                if (data) {
                    // Map Galaxy Lightspeed response to property fields
                    // Adjust based on actual Galaxy API response structure
                    property.revpar = data.revenue_per_available_room || 0;
                    property.pickup7day = data.bookings_last_7_days || 0;
                    property.pickup30day = data.bookings_last_30_days || 0;
                    property.otbNext30 = data.on_the_books_next_30 || 0;
                    property.guestScore = data.guest_satisfaction_score || 0;
                }
            } else if (property.pmsSystem === 'AutoClerk') {
                data = await fetchAutoClerkData(property.autoClerkPropertyId);
                if (data) {
                    // Map AutoClerk Cloud response to property fields
                    // Adjust based on actual AutoClerk API response structure
                    property.revpar = data.revPAR || 0;
                    property.pickup7day = data.reservations_7day || 0;
                    property.pickup30day = data.reservations_30day || 0;
                    property.otbNext30 = data.future_room_nights || 0;
                    property.guestScore = data.average_rating || 0;
                }
            }
        }

        // Helper functions for CloudBeds data processing
        function calculateRevPAR(cloudBedsData) {
            // Logic to calculate RevPAR from CloudBeds reservation data
            // revenue / available rooms
            return 0; // TODO: Implement based on your CloudBeds data structure
        }

        function calculatePickup(cloudBedsData, days) {
            // Logic to calculate pickup for specified days
            return 0; // TODO: Implement
        }

        function calculateOTB(cloudBedsData, days) {
            // Logic to calculate on-the-books
            return 0; // TODO: Implement
        }

        // ========================================
        // DASHBOARD CODE BEGINS
        // ========================================

        // Central Coast California Portfolio - 10 Properties
        // TODO: Update these with your actual property names and room counts
        const properties = [
            { name: 'BEST WESTERN SAN MARCOS', location: 'Morro Bay', revpar: 0, guestScore: 0, staffed: true, pickup7day: 0, pickup30day: 0, otbNext30: 0, stlyRevpar: 0, stlyPickup7: 0, stlyPickup30: 0, stlyOtb: 0, totalRooms: 32, pmsSystem: 'AutoClerk', autoClerkPropertyId: '' },
            { name: 'THE LANDING AT MORRO BAY', location: 'Morro Bay', revpar: 0, guestScore: 0, staffed: true, pickup7day: 0, pickup30day: 0, otbNext30: 0, stlyRevpar: 0, stlyPickup7: 0, stlyPickup30: 0, stlyOtb: 0, totalRooms: 28, pmsSystem: 'CloudBeds', cloudBedsId: '317208' },
            { name: 'Masterpiece Hotel', location: 'Morro Bay', revpar: 0, guestScore: 0, staffed: true, pickup7day: 0, pickup30day: 0, otbNext30: 0, stlyRevpar: 0, stlyPickup7: 0, stlyPickup30: 0, stlyOtb: 0, totalRooms: 29, pmsSystem: 'CloudBeds', cloudBedsId: '318825' },
            { name: 'LA SERENA', location: 'Morro Bay', revpar: 0, guestScore: 0, staffed: true, pickup7day: 0, pickup30day: 0, otbNext30: 0, stlyRevpar: 0, stlyPickup7: 0, stlyPickup30: 0, stlyOtb: 0, totalRooms: 38, pmsSystem: 'ASI', asiCode: '' },
            { name: 'Creekside Inn', location: 'Cambria', revpar: 0, guestScore: 0, staffed: true, pickup7day: 0, pickup30day: 0, otbNext30: 0, stlyRevpar: 0, stlyPickup7: 0, stlyPickup30: 0, stlyOtb: 0, totalRooms: 24, pmsSystem: 'ASI', asiCode: '' },
            { name: 'THE RIGDON HOUSE', location: 'Cambria', revpar: 0, guestScore: 0, staffed: true, pickup7day: 0, pickup30day: 0, otbNext30: 0, stlyRevpar: 0, stlyPickup7: 0, stlyPickup30: 0, stlyOtb: 0, totalRooms: 14, pmsSystem: 'CloudBeds', cloudBedsId: '317207' },
            { name: 'BLUE BIRD INN', location: 'Cambria', revpar: 0, guestScore: 0, staffed: true, pickup7day: 0, pickup30day: 0, otbNext30: 0, stlyRevpar: 0, stlyPickup7: 0, stlyPickup30: 0, stlyOtb: 0, totalRooms: 38, pmsSystem: 'ASI', asiCode: '' },
            { name: 'CARLTON HOTEL', location: 'Atascadero', revpar: 0, guestScore: 0, staffed: true, pickup7day: 0, pickup30day: 0, otbNext30: 0, stlyRevpar: 0, stlyPickup7: 0, stlyPickup30: 0, stlyOtb: 0, totalRooms: 63, pmsSystem: 'GalaxyLightspeed', galaxyHotelCode: '' },
            { name: 'The Grove @ Pismo Beach', location: 'Pismo Beach', revpar: 0, guestScore: 0, staffed: false, pickup7day: 0, pickup30day: 0, otbNext30: 0, stlyRevpar: 0, stlyPickup7: 0, stlyPickup30: 0, stlyOtb: 0, totalRooms: 100, pmsSystem: 'CloudBeds', cloudBedsId: '' },
            { name: 'Property 10 - Shell Beach', location: 'Shell Beach', revpar: 0, guestScore: 0, staffed: true, pickup7day: 0, pickup30day: 0, otbNext30: 0, stlyRevpar: 0, stlyPickup7: 0, stlyPickup30: 0, stlyOtb: 0, totalRooms: 92, pmsSystem: 'AutoClerk', autoClerkPropertyId: '' }
        ];

        const competitors = [
            { name: 'Hilton Downtown', avgPrice: 189, diff: 12 },
            { name: 'Hyatt Regency', avgPrice: 205, diff: -8 },
            { name: 'Sheraton Harbor', avgPrice: 178, diff: 18 }
        ];

        let selectedProperty = null;

        function updateDateTime() {
            const now = new Date();
            const options = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            };
            document.getElementById('dateTime').textContent = now.toLocaleDateString('en-US', options);
        }

        function renderPropertyGrid() {
            const grid = document.getElementById('propertyGrid');
            grid.innerHTML = properties.map((property, index) => {
                const scoreClass = property.guestScore >= 4.6 ? 'positive' : 
                                 property.guestScore >= 4.3 ? '' : 'negative';
                
                // Calculate STLY variances for each metric
                const revparVariance = ((property.revpar - property.stlyRevpar) / property.stlyRevpar) * 100;
                const pickup7Variance = ((property.pickup7day - property.stlyPickup7) / property.stlyPickup7) * 100;
                const pickup30Variance = ((property.pickup30day - property.stlyPickup30) / property.stlyPickup30) * 100;
                const otbVariance = ((property.otbNext30 - property.stlyOtb) / property.stlyOtb) * 100;
                
                // Determine status for each metric
                function getStatStatus(variance) {
                    if (variance < -20) return { class: 'critical', indicator: 'critical' };
                    if (variance < -10) return { class: 'warning', indicator: 'warning' };
                    if (variance > 10) return { class: 'positive-highlight', indicator: 'positive' };
                    return { class: '', indicator: '' };
                }
                
                const revparStatus = getStatStatus(revparVariance);
                const pickup7Status = getStatStatus(pickup7Variance);
                const otbStatus = getStatStatus(otbVariance);
                
                // Guest score status (different logic - based on absolute score)
                const guestStatus = property.guestScore >= 4.6 ? 
                    { class: 'positive-highlight', indicator: 'positive' } : 
                    property.guestScore < 4.3 ? 
                    { class: 'warning', indicator: 'warning' } : 
                    { class: '', indicator: '' };
                
                function renderStat(label, value, status) {
                    const indicator = status.indicator ? 
                        `<div class="stat-indicator ${status.indicator}"></div>` : '';
                    return `
                        <div class="property-card-stat ${status.class}">
                            ${indicator}
                            <div class="property-card-stat-label">${label}</div>
                            <div class="property-card-stat-value">${value}</div>
                        </div>
                    `;
                }
                
                return `
                    <div class="property-card" onclick="selectProperty(${index})">
                        <div class="property-card-name">${property.name}</div>
                        <div class="property-card-location">${property.location}</div>
                        <div class="property-card-stats">
                            ${renderStat('RevPAR', `$${property.revpar}`, revparStatus)}
                            ${renderStat('Score', property.guestScore, guestStatus)}
                            ${renderStat('7-Day Pickup', property.pickup7day, pickup7Status)}
                            ${renderStat('OTB 30', property.otbNext30, otbStatus)}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function selectProperty(index) {
            selectedProperty = properties[index];
            document.querySelector('.property-selector-section').style.display = 'none';
            document.getElementById('propertyDetails').style.display = 'block';
            
            // Update header
            document.getElementById('selectedPropertyName').textContent = selectedProperty.name;
            document.getElementById('selectedPropertyLocation').textContent = selectedProperty.location;
            
            // Calculate STLY variances
            const revparVariance = ((selectedProperty.revpar - selectedProperty.stlyRevpar) / selectedProperty.stlyRevpar) * 100;
            const pickup7Variance = ((selectedProperty.pickup7day - selectedProperty.stlyPickup7) / selectedProperty.stlyPickup7) * 100;
            const pickup30Variance = ((selectedProperty.pickup30day - selectedProperty.stlyPickup30) / selectedProperty.stlyPickup30) * 100;
            const otbVariance = ((selectedProperty.otbNext30 - selectedProperty.stlyOtb) / selectedProperty.stlyOtb) * 100;
            
            // Update metrics with STLY
            document.getElementById('propertyRevPAR').textContent = `$${selectedProperty.revpar}`;
            updateStlyDisplay('revparStly', revparVariance);
            
            document.getElementById('propertyGuestScore').textContent = selectedProperty.guestScore;
            
            document.getElementById('propertyPickup7').textContent = selectedProperty.pickup7day;
            updateStlyDisplay('pickup7Stly', pickup7Variance);
            
            document.getElementById('propertyOtb').textContent = selectedProperty.otbNext30;
            updateStlyDisplay('otbStly', otbVariance);
            
            // Render details
            renderPropertyPickupDetails();
            renderPropertyPricing();
        }

        function updateStlyDisplay(elementId, variance) {
            const element = document.getElementById(elementId);
            const sign = variance > 0 ? '+' : '';
            element.textContent = `${sign}${variance.toFixed(1)}%`;
            
            element.className = 'stly-value';
            if (variance > 5) {
                element.classList.add('positive');
            } else if (variance < -5) {
                element.classList.add('negative');
            } else {
                element.classList.add('neutral');
            }
        }

        function showPropertySelector() {
            document.querySelector('.property-selector-section').style.display = 'block';
            document.getElementById('propertyDetails').style.display = 'none';
            selectedProperty = null;
        }

        function renderPropertyPickupDetails() {
            const container = document.getElementById('propertyPickupDetails');
            const occupancyProjection = ((selectedProperty.otbNext30 / (30 * 100)) * 100).toFixed(0);
            
            const pickup7Variance = ((selectedProperty.pickup7day - selectedProperty.stlyPickup7) / selectedProperty.stlyPickup7) * 100;
            const pickup30Variance = ((selectedProperty.pickup30day - selectedProperty.stlyPickup30) / selectedProperty.stlyPickup30) * 100;
            const otbVariance = ((selectedProperty.otbNext30 - selectedProperty.stlyOtb) / selectedProperty.stlyOtb) * 100;
            
            function getStlyClass(variance) {
                if (variance > 5) return 'positive';
                if (variance < -5) return 'negative';
                return 'neutral';
            }
            
            function formatStly(current, stly, variance) {
                const sign = variance > 0 ? '+' : '';
                return `
                    <div class="stly-comparison">
                        <span class="stly-label">STLY: ${stly}</span>
                        <span class="stly-value ${getStlyClass(variance)}">${sign}${variance.toFixed(1)}%</span>
                    </div>
                `;
            }
            
            container.innerHTML = `
                <div class="pickup-detail-card">
                    <div class="pickup-detail-row">
                        <span class="pickup-detail-label">7-Day Pick-Up</span>
                        <div style="text-align: right;">
                            <div class="pickup-detail-value">${selectedProperty.pickup7day} rooms</div>
                            ${formatStly(selectedProperty.pickup7day, selectedProperty.stlyPickup7, pickup7Variance)}
                        </div>
                    </div>
                    <div class="pickup-detail-row">
                        <span class="pickup-detail-label">30-Day Pick-Up</span>
                        <div style="text-align: right;">
                            <div class="pickup-detail-value">${selectedProperty.pickup30day} rooms</div>
                            ${formatStly(selectedProperty.pickup30day, selectedProperty.stlyPickup30, pickup30Variance)}
                        </div>
                    </div>
                    <div class="pickup-detail-row">
                        <span class="pickup-detail-label">On The Books (Next 30 Days)</span>
                        <div style="text-align: right;">
                            <div class="pickup-detail-value">${selectedProperty.otbNext30} room nights</div>
                            ${formatStly(selectedProperty.otbNext30, selectedProperty.stlyOtb, otbVariance)}
                        </div>
                    </div>
                    <div class="pickup-progress">
                        <div class="pickup-progress-bar" style="width: ${occupancyProjection}%"></div>
                    </div>
                    <div style="text-align: center; margin-top: 8px; color: #6b7280; font-size: 14px;">
                        ${occupancyProjection}% Projected Occupancy
                    </div>
                </div>
                
                <div style="margin-top: 16px;">
                    <div style="font-weight: 600; color: #1a202c; margin-bottom: 12px;">Pick-Up Trend (Last 7 Days)</div>
                    <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px;">
                        ${generatePickupTrend()}
                    </div>
                </div>
            `;
        }

        function generatePickupTrend() {
            const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
            const avgDaily = Math.floor(selectedProperty.pickup7day / 7);
            return days.map(day => {
                const variance = Math.floor(Math.random() * 6) - 3;
                const value = Math.max(0, avgDaily + variance);
                const height = Math.max(20, (value / avgDaily) * 40);
                return `
                    <div style="text-align: center;">
                        <div style="height: 60px; display: flex; align-items: flex-end; justify-content: center;">
                            <div style="width: 100%; background: #667eea; border-radius: 4px; height: ${height}px;"></div>
                        </div>
                        <div style="font-size: 11px; color: #6b7280; margin-top: 4px;">${day}</div>
                        <div style="font-size: 11px; font-weight: 600;">${value}</div>
                    </div>
                `;
            }).join('');
        }

        function renderPropertyPricing() {
            const container = document.getElementById('propertyPricingDetails');
            container.innerHTML = `
                <div class="pricing-card" style="margin-bottom: 16px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                    <div style="font-size: 14px; margin-bottom: 8px; opacity: 0.9;">Your Average Rate</div>
                    <div style="font-size: 32px; font-weight: 700;">$${selectedProperty.revpar}</div>
                </div>
                ${competitors.map(comp => {
                    const ourPrice = selectedProperty.revpar;
                    const actualDiff = comp.avgPrice - ourPrice;
                    const diffClass = actualDiff > 0 ? 'negative' : 'positive';
                    const diffSymbol = actualDiff > 0 ? '+' : '';
                    return `
                        <div class="pricing-card" style="margin-bottom: 12px;">
                            <div class="pricing-header">
                                <span class="competitor-name">${comp.name}</span>
                            </div>
                            <div class="price-comparison">
                                <span class="price-value">$${comp.avgPrice}</span>
                                <span class="price-diff metric-change ${diffClass}">${diffSymbol}$${actualDiff}</span>
                            </div>
                        </div>
                    `;
                }).join('')}
            `;
        }

        function refreshData() {
            properties.forEach(p => {
                p.revpar += Math.floor(Math.random() * 10) - 5;
                p.guestScore += (Math.random() * 0.2) - 0.1;
                p.guestScore = Math.max(3.5, Math.min(5.0, p.guestScore));
                p.pickup7day += Math.floor(Math.random() * 10) - 3;
                p.pickup7day = Math.max(0, p.pickup7day);
                p.otbNext30 += Math.floor(Math.random() * 50) - 20;
                p.otbNext30 = Math.max(500, p.otbNext30);
                
                // Keep STLY data relatively stable with minor fluctuations
                p.stlyRevpar += Math.floor(Math.random() * 3) - 1;
                p.stlyPickup7 += Math.floor(Math.random() * 3) - 1;
                p.stlyPickup7 = Math.max(0, p.stlyPickup7);
            });
            
            if (selectedProperty) {
                const index = properties.findIndex(p => p.name === selectedProperty.name);
                if (index !== -1) {
                    selectProperty(index);
                }
            } else {
                renderPropertyGrid();
            }
            
            const btn = event.target;
            btn.textContent = 'Refreshed ✓';
            setTimeout(() => {
                btn.textContent = 'Refresh Data';
            }, 2000);
        }

        // SYNC ALL PROPERTIES FROM PMS
        async function syncAllProperties() {
            const btn = event.target;
            btn.textContent = 'Syncing...';
            btn.disabled = true;

            try {
                // Update each property from its respective PMS
                for (const property of properties) {
                    await updatePropertyFromPMS(property);
                }

                // Refresh the display
                if (selectedProperty) {
                    const index = properties.findIndex(p => p.name === selectedProperty.name);
                    if (index !== -1) {
                        selectProperty(index);
                    }
                } else {
                    renderPropertyGrid();
                }

                btn.textContent = 'Synced ✓';
            } catch (error) {
                console.error('Sync error:', error);
                alert('PMS sync failed. Please check API credentials and try again.');
                btn.textContent = 'Sync Failed';
            } finally {
                btn.disabled = false;
                setTimeout(() => {
                    btn.textContent = 'Sync PMS';
                }, 2000);
            }
        }

        // Initialize dashboard
        updateDateTime();
        setInterval(updateDateTime, 1000);
        renderPropertyGrid();

        // Auto-refresh metrics every 30 seconds
        setInterval(() => {
            if (selectedProperty) {
                const index = properties.findIndex(p => p.name === selectedProperty.name);
                if (index !== -1) {
                    selectProperty(index);
                }
            }
        }, 30000);
    </script>
</body>
</html>
